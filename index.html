<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Type-Implicit C Editor</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #editor { width: 100%; height: 95vh; font-family: monospace; font-size: 16px; padding: 10px; box-sizing: border-box; white-space: pre; overflow: auto; }
    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 5px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      pointer-events: none;
      z-index: 100;
    }
  </style>
</head>
<body>

<textarea id="editor">// Start typing C code
x = 5;
y = 3.14;
</textarea>

<div id="tooltip" class="tooltip"></div>

<script>
const editor = document.getElementById('editor');
const tooltip = document.getElementById('tooltip');

const basicTypes = ["int", "float", "char", "double", "void"];
let variableTypes = {};

// Find variables
function findVariables(text) {
  const varRegex = /\b([a-zA-Z_][a-zA-Z0-9_]*)\b/g;
  const matches = new Set();
  let match;
  while ((match = varRegex.exec(text)) !== null) {
    const name = match[1];
    if (!basicTypes.includes(name)) {
      matches.add(name);
    }
  }
  return Array.from(matches);
}

// Get word at mouse position
function getWordAtCursorPosition(text, pos) {
  let start = pos;
  let end = pos;
  while (start > 0 && /[a-zA-Z0-9_]/.test(text[start - 1])) start--;
  while (end < text.length && /[a-zA-Z0-9_]/.test(text[end])) end++;
  return text.slice(start, end);
}

// Save
function handleSave() {
  const vars = findVariables(editor.value);
  const untyped = vars.filter(v => !variableTypes[v]);
  if (untyped.length > 0) {
    alert("Missing types for: " + untyped.join(", "));
  } else {
    alert("All variables have types! âœ…");
    console.log("Saving with types:", variableTypes);
  }
}

// Handle hover
editor.addEventListener('mousemove', (e) => {
  const rect = editor.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  
  const lines = editor.value.split('\\n');
  const approxLine = Math.floor((y / editor.clientHeight) * lines.length);
  const lineText = lines[approxLine] || "";
  
  const approxChar = Math.floor((x / editor.clientWidth) * lineText.length);
  
  const cursorIndex = lines.slice(0, approxLine).reduce((sum, l) => sum + l.length + 1, 0) + approxChar;
  
  const word = getWordAtCursorPosition(editor.value, cursorIndex);
  
  if (word && variableTypes[word]) {
    tooltip.innerHTML = "Type: " + variableTypes[word];
    tooltip.style.left = e.pageX + 10 + "px";
    tooltip.style.top = e.pageY + 10 + "px";
    tooltip.style.display = "block";
  } else {
    tooltip.style.display = "none";
  }
});

// Click to assign type
editor.addEventListener('click', (e) => {
  const pos = editor.selectionStart;
  const word = getWordAtCursorPosition(editor.value, pos);

  if (word && !basicTypes.includes(word)) {
    const type = prompt(`Select type for '${word}':\\n${basicTypes.join(", ")}`);
    if (basicTypes.includes(type)) {
      variableTypes[word] = type;
    }
  }
});

// Ctrl+S for save
window.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    handleSave();
  }
});
</script>

</body>
</html>
